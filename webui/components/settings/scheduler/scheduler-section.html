<html>
<head>
</head>
<body>

    <div id="section-task-scheduler" class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700" x-data="schedulerSettings">
        <h2 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Task Scheduler</h2>
        <p class="mb-6 font-normal text-gray-700 dark:text-gray-400">Manage scheduled tasks and automated processes for Agent Zero.</p>

        <!-- Create Task Form -->
        <div class="flex flex-col gap-6" x-show="isCreating">
            <div class="flex items-center justify-between pb-4 border-b border-gray-200 dark:border-gray-700">
                <div class="text-xl font-bold text-gray-900 dark:text-white">Create New Task</div>
                <div class="flex gap-2">
                    <button class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800" @click="saveTask()">
                        Save
                    </button>
                    <button class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700" @click="cancelEdit()">
                        Cancel
                    </button>
                </div>
            </div>

            <div class="grid gap-6">
                <!-- Task Name -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Task Name</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">A unique name to identify this task</p>
                    </div>
                    <input type="text" x-model="editingTask.name" placeholder="Enter task name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                </div>

                <!-- Task Type Selection -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Type</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Task execution method</p>
                    </div>
                    <select x-model="editingTask.type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                        <option value="scheduled">Scheduled (Cron)</option>
                        <option value="adhoc">Ad-hoc (Manual)</option>
                        <option value="planned">Planned (Specific Times)</option>
                    </select>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Project</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="editingTask.dedicated_context ? 'Inherited from the active chat project.' : 'Mirrors the shared context project.'"></p>
                    </div>
                    <template x-if="isCreating">
                        <div class="project-selector">
                            <select x-model="selectedProjectSlug" @change="onProjectSelect($event.target.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                <option value="">No project</option>
                                <template x-for="proj in projectOptions" :key="proj.name">
                                    <option :value="proj.name" x-text="proj.title"></option>
                                </template>
                            </select>
                        </div>
                    </template>
                    <template x-if="!isCreating">
                        <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                            <span class="w-3 h-3 rounded-full" :style="editingTask.project?.color ? { backgroundColor: editingTask.project.color } : { border: '1px solid var(--color-border)' }"></span>
                            <span class="text-sm text-gray-900 dark:text-white" x-text="formatProjectLabel(editingTask.project)"></span>
                        </div>
                    </template>
                </div>

                <!-- Task State in Create Form - Add after Task Type -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start" x-show="isCreating">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">State</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Select the initial state of the task</p>
                    </div>
                    <div>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="px-3 py-1 text-xs font-medium text-center rounded-full cursor-pointer border transition-all"
                                :class="editingTask.state === 'idle' 
                                    ? 'bg-blue-100 text-blue-800 border-blue-400 dark:bg-blue-900 dark:text-blue-300 ring-2 ring-blue-500 ring-offset-1 dark:ring-offset-gray-800' 
                                    : 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600'"
                                @click="editingTask.state = 'idle'">idle</span>
                            <span class="px-3 py-1 text-xs font-medium text-center rounded-full cursor-pointer border transition-all"
                                :class="editingTask.state === 'running' 
                                    ? 'bg-yellow-100 text-yellow-800 border-yellow-400 dark:bg-yellow-900 dark:text-yellow-300 ring-2 ring-yellow-500 ring-offset-1 dark:ring-offset-gray-800' 
                                    : 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600'"
                                @click="editingTask.state = 'running'">running</span>
                            <span class="px-3 py-1 text-xs font-medium text-center rounded-full cursor-pointer border transition-all"
                                :class="editingTask.state === 'disabled' 
                                    ? 'bg-gray-300 text-gray-800 border-gray-500 dark:bg-gray-600 dark:text-gray-200 ring-2 ring-gray-500 ring-offset-1 dark:ring-offset-gray-800' 
                                    : 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600'"
                                @click="editingTask.state = 'disabled'">disabled</span>
                            <span class="px-3 py-1 text-xs font-medium text-center rounded-full cursor-pointer border transition-all"
                                :class="editingTask.state === 'error' 
                                    ? 'bg-red-100 text-red-800 border-red-400 dark:bg-red-900 dark:text-red-300 ring-2 ring-red-500 ring-offset-1 dark:ring-offset-gray-800' 
                                    : 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600'"
                                @click="editingTask.state = 'error'">error</span>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <span x-show="editingTask.state === 'idle'"><strong>idle</strong>: ready to run</span>
                            <span x-show="editingTask.state === 'running'"><strong>running</strong>: currently executing</span>
                            <span x-show="editingTask.state === 'disabled'"><strong>disabled</strong>: won't execute automatically</span>
                            <span x-show="editingTask.state === 'error'"><strong>error</strong>: task encountered an error</span>
                        </div>
                    </div>
                </div>

                <!-- Schedule (only for scheduled tasks) -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start" x-show="editingTask.type === 'scheduled'">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Schedule</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Cron schedule (minute hour day month weekday)</p>
                    </div>
                    <div class="grid grid-cols-5 gap-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">Min</span>
                            <input type="text" x-model="editingTask.schedule.minute" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">Hour</span>
                            <input type="text" x-model="editingTask.schedule.hour" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">Day</span>
                            <input type="text" x-model="editingTask.schedule.day" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">Mon</span>
                            <input type="text" x-model="editingTask.schedule.month" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">WkDay</span>
                            <input type="text" x-model="editingTask.schedule.weekday" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                    </div>
                </div>

                <!-- Plan (for planned tasks) -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start" x-show="editingTask.type === 'planned'">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Plan</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Specific execution times for this task</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                        <div class="mb-2 font-medium text-sm text-gray-900 dark:text-white">Upcoming Executions</div>
                        <div class="flex flex-col gap-2 max-h-48 overflow-y-auto mb-3">
                            <template x-if="editingTask.plan && Array.isArray(editingTask.plan.todo) && editingTask.plan.todo.length > 0">
                                <template x-for="(time, index) in editingTask.plan.todo" :key="index">
                                    <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded">
                                        <span class="text-sm text-gray-700 dark:text-gray-300" x-text="formatDate(time)"></span>
                                        <button @click.prevent="editingTask.plan.todo.splice(index, 1)" class="text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!editingTask.plan || !Array.isArray(editingTask.plan.todo) || editingTask.plan.todo.length === 0">
                                <div class="text-center py-4 text-sm text-gray-500 dark:text-gray-400 italic border border-dashed border-gray-300 dark:border-gray-600 rounded">
                                    No scheduled execution times yet. Add one below.
                                </div>
                            </template>
                        </div>
                        <div class="flex gap-2 items-center">
                            <!-- Create form planned task input -->
                            <div class="relative flex-1">
                                <input type="text" id="newPlannedTime-create" x-ref="plannedTimeCreate" class="scheduler-flatpickr-input bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-800 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Select date and time">
                            </div>
                            <button @click.prevent="
                                const input = $refs.plannedTimeCreate;
                                if (!input) { console.error('Input reference not found'); return; }
                                if (!editingTask.plan) { editingTask.plan = { todo: [], in_progress: null, done: [] }; }
                                if (!Array.isArray(editingTask.plan.todo)) { editingTask.plan.todo = []; }
                                let selectedDate;
                                if (input._flatpickr && input._flatpickr.selectedDates.length > 0) { selectedDate = input._flatpickr.selectedDates[0]; } 
                                else if (input.value) { selectedDate = new Date(input.value); }
                                if (!selectedDate || isNaN(selectedDate.getTime())) { alert('Please select a valid date and time'); return; }
                                editingTask.plan.todo.push(selectedDate.toISOString());
                                editingTask.plan.todo.sort();
                                if (input._flatpickr) { input._flatpickr.clear(); } else { input.value = ''; }
                            " class="px-3 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Add
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Token (for ad-hoc tasks) -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start" x-show="editingTask.type === 'adhoc'">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Token</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Token used to trigger this task externally</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" x-model="editingTask.token" placeholder="Token for ad-hoc task" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 flex-1">
                        <button class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-4 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700 whitespace-nowrap" @click="editingTask.token = generateRandomToken()">
                            Generate
                        </button>
                    </div>
                </div>

                <!-- System Prompt -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">System Prompt</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">System-level instructions for the assistant</p>
                    </div>
                    <textarea x-model="editingTask.system_prompt" placeholder="System instructions for the AI" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 font-mono"></textarea>
                </div>

                <!-- User Prompt -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">User Prompt</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">The main task prompt that will be executed</p>
                    </div>
                    <textarea x-model="editingTask.prompt" placeholder="User message for the AI" rows="5" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 font-mono"></textarea>
                </div>

                <!-- Attachments Field -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Attachments</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Container file paths or URLs, one per line</p>
                    </div>
                    <textarea x-model="attachmentsText" placeholder="Enter file paths or URLs, one per line" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 font-mono"></textarea>
                </div>
            </div>
        </div>

        <!-- Edit Task Form -->
        <div class="flex flex-col gap-6" x-show="isEditing">
            <div class="flex items-center justify-between pb-4 border-b border-gray-200 dark:border-gray-700">
                <div class="text-xl font-bold text-gray-900 dark:text-white">Edit Task</div>
                <div class="flex gap-2">
                    <button class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800" @click="saveTask()">
                        Save
                    </button>
                    <button class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700" @click="cancelEdit()">
                        Cancel
                    </button>
                </div>
            </div>

            <div class="grid gap-6">
                <!-- Task Name -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Task Name</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">A unique name to identify this task</p>
                    </div>
                    <input type="text" x-model="editingTask.name" placeholder="Enter task name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                </div>

                <!-- Task Type (disabled when editing) -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Task Type</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Task type cannot be changed after creation</p>
                    </div>
                    <select x-model="editingTask.type" disabled class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg cursor-not-allowed focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-gray-400 dark:focus:ring-blue-500 dark:focus:border-blue-500">
                        <option value="scheduled">Scheduled Task</option>
                        <option value="adhoc">Ad-hoc Task</option>
                        <option value="planned">Planned Task</option>
                    </select>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Project</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400" x-text="editingTask.dedicated_context ? 'Dedicated tasks inherit the active chat project.' : 'Shared tasks mirror the project assigned to their context.'"></p>
                    </div>
                    <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                        <span class="w-3 h-3 rounded-full" :style="editingTask.project?.color ? { backgroundColor: editingTask.project.color } : { border: '1px solid var(--color-border)' }"></span>
                        <span class="text-sm text-gray-900 dark:text-white" x-text="formatProjectLabel(editingTask.project)"></span>
                    </div>
                </div>

                <!-- Task State in Edit Form -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">State</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Change the task's state</p>
                    </div>
                    <div>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="px-3 py-1 text-xs font-medium text-center rounded-full cursor-pointer border transition-all"
                                :class="editingTask.state === 'idle' 
                                    ? 'bg-blue-100 text-blue-800 border-blue-400 dark:bg-blue-900 dark:text-blue-300 ring-2 ring-blue-500 ring-offset-1 dark:ring-offset-gray-800' 
                                    : 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600'"
                                @click="editingTask.state = 'idle'">idle</span>
                            <span class="px-3 py-1 text-xs font-medium text-center rounded-full cursor-pointer border transition-all"
                                :class="editingTask.state === 'running' 
                                    ? 'bg-yellow-100 text-yellow-800 border-yellow-400 dark:bg-yellow-900 dark:text-yellow-300 ring-2 ring-yellow-500 ring-offset-1 dark:ring-offset-gray-800' 
                                    : 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600'"
                                @click="editingTask.state = 'running'">running</span>
                            <span class="px-3 py-1 text-xs font-medium text-center rounded-full cursor-pointer border transition-all"
                                :class="editingTask.state === 'disabled' 
                                    ? 'bg-gray-300 text-gray-800 border-gray-500 dark:bg-gray-600 dark:text-gray-200 ring-2 ring-gray-500 ring-offset-1 dark:ring-offset-gray-800' 
                                    : 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600'"
                                @click="editingTask.state = 'disabled'">disabled</span>
                            <span class="px-3 py-1 text-xs font-medium text-center rounded-full cursor-pointer border transition-all"
                                :class="editingTask.state === 'error' 
                                    ? 'bg-red-100 text-red-800 border-red-400 dark:bg-red-900 dark:text-red-300 ring-2 ring-red-500 ring-offset-1 dark:ring-offset-gray-800' 
                                    : 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600'"
                                @click="editingTask.state = 'error'">error</span>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <span x-show="editingTask.state === 'idle'"><strong>idle</strong>: ready to run</span>
                            <span x-show="editingTask.state === 'running'"><strong>running</strong>: currently executing</span>
                            <span x-show="editingTask.state === 'disabled'"><strong>disabled</strong>: won't execute automatically</span>
                            <span x-show="editingTask.state === 'error'"><strong>error</strong>: task encountered an error</span>
                        </div>
                    </div>
                </div>

                <!-- Schedule (for scheduled tasks) -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start" x-show="editingTask && editingTask.type === 'scheduled'">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Schedule</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Cron schedule (minute hour day month weekday)</p>
                    </div>
                    <div class="grid grid-cols-5 gap-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">Min</span>
                            <input type="text" x-model="editingTask.schedule.minute" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">Hour</span>
                            <input type="text" x-model="editingTask.schedule.hour" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">Day</span>
                            <input type="text" x-model="editingTask.schedule.day" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">Mon</span>
                            <input type="text" x-model="editingTask.schedule.month" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 dark:text-gray-400 mb-1">WkDay</span>
                            <input type="text" x-model="editingTask.schedule.weekday" placeholder="*" maxlength="9" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 text-center">
                        </div>
                    </div>
                </div>

                <!-- Plan (for planned tasks) -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start" x-show="editingTask.type === 'planned'">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Plan</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Specific execution times for this task</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                        <div class="mb-2 font-medium text-sm text-gray-900 dark:text-white">Upcoming Executions</div>
                        <div class="flex flex-col gap-2 max-h-48 overflow-y-auto mb-3">
                            <template x-if="editingTask.plan && Array.isArray(editingTask.plan.todo) && editingTask.plan.todo.length > 0">
                                <template x-for="(time, index) in editingTask.plan.todo" :key="index">
                                    <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded">
                                        <span class="text-sm text-gray-700 dark:text-gray-300" x-text="formatDate(time)"></span>
                                        <button @click.prevent="editingTask.plan.todo.splice(index, 1)" class="text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                    </div>
                                </template>
                            </template>
                            <template x-if="!editingTask.plan || !Array.isArray(editingTask.plan.todo) || editingTask.plan.todo.length === 0">
                                <div class="text-center py-4 text-sm text-gray-500 dark:text-gray-400 italic border border-dashed border-gray-300 dark:border-gray-600 rounded">
                                    No scheduled execution times yet. Add one below.
                                </div>
                            </template>
                        </div>
                        <div class="flex gap-2 items-center">
                            <!-- Edit form planned task input -->
                            <div class="relative flex-1">
                                <input type="text" id="newPlannedTime-edit" x-ref="plannedTimeEdit" class="scheduler-flatpickr-input bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-800 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Select date and time">
                            </div>
                            <button @click.prevent="
                                const input = $refs.plannedTimeEdit;
                                if (!input) { console.error('Input reference not found'); return; }
                                if (!editingTask.plan) { editingTask.plan = { todo: [], in_progress: null, done: [] }; }
                                if (!Array.isArray(editingTask.plan.todo)) { editingTask.plan.todo = []; }
                                let selectedDate;
                                if (input._flatpickr && input._flatpickr.selectedDates.length > 0) { selectedDate = input._flatpickr.selectedDates[0]; } 
                                else if (input.value) { selectedDate = new Date(input.value); }
                                if (!selectedDate || isNaN(selectedDate.getTime())) { alert('Please select a valid date and time'); return; }
                                editingTask.plan.todo.push(selectedDate.toISOString());
                                editingTask.plan.todo.sort();
                                if (input._flatpickr) { input._flatpickr.clear(); } else { input.value = ''; }
                            " class="px-3 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Add
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Token (for ad-hoc tasks) -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start" x-show="editingTask.type === 'adhoc'">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Token</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Token used to trigger this task externally</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" x-model="editingTask.token" placeholder="Token for ad-hoc task" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 flex-1">
                        <button class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-4 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700 whitespace-nowrap" @click="editingTask.token = generateRandomToken()">
                            Generate
                        </button>
                    </div>
                </div>

                <!-- System Prompt -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">System Prompt</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">System-level instructions for the assistant</p>
                    </div>
                    <textarea x-model="editingTask.system_prompt" placeholder="System instructions for the AI" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 font-mono"></textarea>
                </div>

                <!-- User Prompt -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">User Prompt</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">The main task prompt that will be executed</p>
                    </div>
                    <textarea x-model="editingTask.prompt" placeholder="User message for the AI" rows="5" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 font-mono"></textarea>
                </div>

                <!-- Attachments Field -->
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] items-start">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-900 dark:text-white">Attachments</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Container file paths or URLs, one per line</p>
                    </div>
                    <textarea x-model="attachmentsText" placeholder="Enter file paths or URLs, one per line" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 font-mono"></textarea>
                </div>
            </div>
        </div>

        <!-- Task List View -->
        <div class="flex flex-col gap-4" x-show="!isCreating && !isEditing && viewMode === 'list'">
            <!-- Header with Actions -->
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-2">
                <!-- Filters -->
                <div class="flex flex-wrap gap-4 w-full sm:w-auto">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Type:</span>
                        <select x-model="filterType" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                            <option value="all">All Types</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="adhoc">Ad-hoc</option>
                            <option value="planned">Planned</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">State:</span>
                        <select x-model="filterState" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                            <option value="all">All States</option>
                            <option value="idle">Idle</option>
                            <option value="running">Running</option>
                            <option value="disabled">Disabled</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-2 w-full sm:w-auto justify-end">
                    <button class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800" @click="startCreateTask()">
                        New Task
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div class="text-center py-12" x-show="!isLoading && filteredTasks.length === 0" x-effect="$el.style.display = (!isLoading && filteredTasks.length === 0) ? '' : 'none'">
                <div class="text-gray-500 dark:text-gray-400 mb-4 text-lg">No tasks found</div>
                <button class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800" @click="startCreateTask()">Create your first task</button>
            </div>

            <!-- Task List Table -->
            <div class="relative overflow-x-auto shadow-md sm:rounded-lg border border-gray-200 dark:border-gray-700" x-show="!isLoading && filteredTasks.length > 0" x-effect="$el.style.display = (!isLoading && filteredTasks.length > 0) ? '' : 'none'">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" class="px-6 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" @click="changeSort('name')">
                                Name
                                <span x-show="sortField === 'name'" x-text="sortDirection === 'asc' ? '↑' : '↓'" class="ml-1"></span>
                            </th>
                            <th scope="col" class="px-6 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" @click="changeSort('state')">
                                State
                                <span x-show="sortField === 'state'" x-text="sortDirection === 'asc' ? '↑' : '↓'" class="ml-1"></span>
                            </th>
                            <th scope="col" class="px-6 py-3">Type</th>
                            <th scope="col" class="px-6 py-3">Project</th>
                            <th scope="col" class="px-6 py-3">Schedule</th>
                            <th scope="col" class="px-6 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" @click="changeSort('last_run')">
                                Last Run
                                <span x-show="sortField === 'last_run'" x-text="sortDirection === 'asc' ? '↑' : '↓'" class="ml-1"></span>
                            </th>
                            <th scope="col" class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="task in filteredTasks" :key="task.uuid">
                            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer" @click="showTaskDetail(task.uuid)">
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                    <span x-text="task.name"></span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-2.5 py-0.5 rounded text-xs font-medium border" :class="getStateBadgeClass(task.state)" x-text="task.state"></span>
                                </td>
                                <td class="px-6 py-4" x-text="task.type"></td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <span class="w-2.5 h-2.5 rounded-full" :style="extractTaskProject(task)?.color ? { backgroundColor: extractTaskProject(task).color } : { border: '1px solid var(--color-border)' }"></span>
                                        <span x-text="formatTaskProject(task)"></span>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span x-show="task.type === 'scheduled'" x-text="formatSchedule(task)"></span>
                                    <span x-show="task.type === 'adhoc'">—</span>
                                    <span x-show="task.type === 'planned'" x-html="formatPlan(task).replace(/\n/g, '<br>')"></span>
                                </td>
                                <td class="px-6 py-4" x-text="formatDate(task.last_run)"></td>
                                <td class="px-6 py-4 text-right" @click.stop>
                                    <div class="flex justify-end gap-2">
                                        <button class="p-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" @click="runTask(task.uuid)" title="Run Task">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M8 5v14l11-7z" /></svg>
                                        </button>
                                        <button class="p-1 text-gray-500 hover:text-yellow-600 dark:text-gray-400 dark:hover:text-yellow-400 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" @click="resetTaskState(task.uuid)" title="Reset State">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" /></svg>
                                        </button>
                                        <button class="p-1 text-gray-500 hover:text-green-600 dark:text-gray-400 dark:hover:text-green-400 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" @click="startEditTask(task.uuid)" title="Edit Task">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" /></svg>
                                        </button>
                                        <button class="p-1 text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" @click="deleteTask(task.uuid)" title="Delete Task">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" /></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Task Detail View -->
        <div class="flex flex-col gap-6" x-show="!isCreating && !isEditing && viewMode === 'detail' && selectedTaskForDetail">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white" x-text="selectedTaskForDetail ? selectedTaskForDetail.name : ''"></h2>
                    <span class="px-2.5 py-0.5 rounded text-xs font-medium border" 
                        :class="selectedTaskForDetail ? getStateBadgeClass(selectedTaskForDetail.state) : ''"
                        x-text="selectedTaskForDetail ? selectedTaskForDetail.state : ''">
                    </span>
                </div>
                <button class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700" @click="closeTaskDetail()">Close</button>
            </div>

            <div class="grid gap-6">
                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Type:</div>
                    <div class="text-gray-900 dark:text-white" x-text="selectedTaskForDetail ? selectedTaskForDetail.type : ''"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Project:</div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full" :style="extractTaskProject(selectedTaskForDetail)?.color ? { backgroundColor: extractTaskProject(selectedTaskForDetail).color } : { border: '1px solid var(--color-border)' }"></span>
                        <span class="text-gray-900 dark:text-white" x-text="selectedTaskForDetail ? formatTaskProject(selectedTaskForDetail) : 'No Project'"></span>
                    </div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Created:</div>
                    <div class="text-gray-900 dark:text-white" x-text="selectedTaskForDetail ? formatDate(selectedTaskForDetail.created_at) : ''"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Last Updated:</div>
                    <div class="text-gray-900 dark:text-white" x-text="selectedTaskForDetail ? formatDate(selectedTaskForDetail.updated_at) : ''"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Last Run:</div>
                    <div class="text-gray-900 dark:text-white" x-text="selectedTaskForDetail ? formatDate(selectedTaskForDetail.last_run) : ''"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4" x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'scheduled'">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Schedule:</div>
                    <div class="text-gray-900 dark:text-white font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded inline-block" x-text="selectedTaskForDetail ? formatSchedule(selectedTaskForDetail) : ''"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4" x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'adhoc'">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Token:</div>
                    <div class="text-gray-900 dark:text-white font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded inline-block break-all" x-text="selectedTaskForDetail ? selectedTaskForDetail.token : ''"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4" x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'planned'">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Plan:</div>
                    <div class="text-gray-900 dark:text-white" x-show="selectedTaskForDetail && selectedTaskForDetail.type === 'planned'">
                        <div x-show="selectedTaskForDetail && selectedTaskForDetail.plan" class="flex flex-col gap-4">
                            <div>
                                <div class="font-medium mb-1 text-sm text-gray-600 dark:text-gray-400">Upcoming:</div>
                                <template x-if="selectedTaskForDetail && selectedTaskForDetail.plan && selectedTaskForDetail.plan.todo && selectedTaskForDetail.plan.todo.length > 0">
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded p-2 border border-gray-200 dark:border-gray-600">
                                        <template x-for="(time, index) in selectedTaskForDetail.plan.todo" :key="index">
                                            <div x-text="formatDate(time)" class="text-sm py-1 border-b border-gray-200 dark:border-gray-600 last:border-0"></div>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="!selectedTaskForDetail || !selectedTaskForDetail.plan || !selectedTaskForDetail.plan.todo || selectedTaskForDetail.plan.todo.length === 0">
                                    <div class="text-gray-500 italic text-sm">No upcoming executions</div>
                                </template>
                            </div>

                            <div>
                                <div class="font-medium mb-1 text-sm text-gray-600 dark:text-gray-400">In Progress:</div>
                                <div class="text-sm" x-text="selectedTaskForDetail && selectedTaskForDetail.plan && selectedTaskForDetail.plan.in_progress ? formatDate(selectedTaskForDetail.plan.in_progress) : 'None'"></div>
                            </div>

                            <div>
                                <div class="font-medium mb-1 text-sm text-gray-600 dark:text-gray-400">Completed:</div>
                                <template x-if="selectedTaskForDetail && selectedTaskForDetail.plan && selectedTaskForDetail.plan.done && selectedTaskForDetail.plan.done.length > 0">
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded p-2 border border-gray-200 dark:border-gray-600 max-h-32 overflow-y-auto">
                                        <template x-for="(time, index) in selectedTaskForDetail.plan.done" :key="index">
                                            <div x-text="formatDate(time)" class="text-sm py-1 border-b border-gray-200 dark:border-gray-600 last:border-0"></div>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="!selectedTaskForDetail || !selectedTaskForDetail.plan || !selectedTaskForDetail.plan.done || selectedTaskForDetail.plan.done.length === 0">
                                    <div class="text-gray-500 italic text-sm">No completed executions</div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Last Result:</div>
                    <div class="text-gray-900 dark:text-white bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm font-mono whitespace-pre-wrap max-h-48 overflow-y-auto" x-text="selectedTaskForDetail && selectedTaskForDetail.last_result ? selectedTaskForDetail.last_result : 'No results yet'"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="font-medium text-gray-700 dark:text-gray-300">System Prompt:</div>
                    <div class="text-gray-900 dark:text-white bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm font-mono whitespace-pre-wrap max-h-48 overflow-y-auto" x-text="selectedTaskForDetail ? selectedTaskForDetail.system_prompt : ''"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr] border-b border-gray-200 dark:border-gray-700 pb-4">
                    <div class="font-medium text-gray-700 dark:text-gray-300">User Prompt:</div>
                    <div class="text-gray-900 dark:text-white bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-sm font-mono whitespace-pre-wrap max-h-48 overflow-y-auto" x-text="selectedTaskForDetail ? selectedTaskForDetail.prompt : ''"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-[1fr_2fr]">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Attachments:</div>
                    <div class="text-gray-900 dark:text-white">
                        <template x-if="selectedTaskForDetail && selectedTaskForDetail.attachments && selectedTaskForDetail.attachments.length > 0">
                            <div class="flex flex-col gap-1">
                                <template x-for="(attachment, index) in selectedTaskForDetail.attachments" :key="index">
                                    <div class="bg-gray-50 dark:bg-gray-700 px-2 py-1 rounded text-sm font-mono break-all" x-text="attachment"></div>
                                </template>
                            </div>
                        </template>
                        <template x-if="!selectedTaskForDetail || !selectedTaskForDetail.attachments || selectedTaskForDetail.attachments.length === 0">
                            <div class="text-gray-500 italic">No attachments</div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
