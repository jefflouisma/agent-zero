<html>
<head>
    <title>Memory Dashboard</title>
    <script type="module">
        import { store } from "/components/settings/memory/memory-dashboard-store.js";
    </script>
</head>
<body>
    <div x-data class="flex flex-col h-full p-4 overflow-hidden">
        <template x-if="$store.memoryDashboardStore">
            <div x-create="$store.memoryDashboardStore.onOpen()" x-destroy="$store.memoryDashboardStore.cleanup()"
                class="flex flex-col h-full space-y-4">

                <!-- Search and Filters Section -->
                <div class="flex flex-col lg:flex-row gap-4 p-4 bg-gray-50 border border-gray-200 rounded-lg dark:bg-gray-800 dark:border-gray-700">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 w-full">
                        <!-- Memory Directory -->
                        <div class="flex flex-col gap-1">
                            <label for="memory-subdir-select" class="text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">Directory</label>
                            <select id="memory-subdir-select" x-model="$store.memoryDashboardStore.selectedMemorySubdir"
                                @change="$store.memoryDashboardStore.onMemorySubdirChange()"
                                :disabled="$store.memoryDashboardStore.loadingSubdirs"
                                class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                <template x-for="subdir in $store.memoryDashboardStore.memorySubdirs" :key="subdir">
                                    <option :value="subdir" x-text="subdir"
                                        :selected="subdir === $store.memoryDashboardStore.selectedMemorySubdir">
                                    </option>
                                </template>
                            </select>
                        </div>

                        <!-- Area Filter -->
                        <div class="flex flex-col gap-1">
                            <label for="area-filter" class="text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">Area</label>
                            <select id="area-filter" x-model="$store.memoryDashboardStore.areaFilter"
                                class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                <option value="">All Areas</option>
                                <option value="main">Main</option>
                                <option value="fragments">Fragments</option>
                                <option value="solutions">Solutions</option>
                                <option value="instruments">Instruments</option>
                            </select>
                        </div>

                        <!-- Limit -->
                        <div class="flex flex-col gap-1">
                            <label for="limit-input" class="text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">Limit</label>
                            <input type="number" id="limit-input" x-model.number="$store.memoryDashboardStore.limit"
                                min="10" max="1000" step="10"
                                class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" />
                        </div>

                        <!-- Threshold -->
                        <div class="flex flex-col gap-1">
                            <label for="threshold-input" class="text-xs font-semibold text-gray-500 uppercase dark:text-gray-400 flex justify-between">
                                <span>Threshold</span>
                                <strong class="text-blue-600 dark:text-blue-400" x-text="$store.memoryDashboardStore.threshold.toFixed(2)"></strong>
                            </label>
                            <input type="range" id="threshold-input" x-model.number="$store.memoryDashboardStore.threshold"
                                min="0" max="1" step="0.01" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 mt-2" />
                        </div>
                    </div>

                    <!-- Search Input and Buttons -->
                    <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto items-end">
                        <div class="w-full lg:w-64">
                            <label for="search-input" class="sr-only">Search</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">search</span>
                                </div>
                                <input type="text" id="search-input" x-model="$store.memoryDashboardStore.searchQuery"
                                    placeholder="Search content..."
                                    class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                    @keyup.enter="$store.memoryDashboardStore.searchMemories()" />
                            </div>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button class="flex-1 sm:flex-none px-4 py-2.5 text-sm font-medium text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800 disabled:opacity-50 disabled:cursor-not-allowed"
                                @click="$store.memoryDashboardStore.searchMemories()"
                                :disabled="$store.memoryDashboardStore.loading || $store.memoryDashboardStore.loadingSubdirs">
                                <span x-show="!$store.memoryDashboardStore.initializingMemory">Search</span>
                                <span x-show="$store.memoryDashboardStore.initializingMemory">Init...</span>
                            </button>
                            <button class="flex-1 sm:flex-none px-4 py-2.5 text-sm font-medium text-gray-900 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700"
                                @click="$store.memoryDashboardStore.clearSearch()">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading state -->
                <div x-show="$store.memoryDashboardStore.loading" class="flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400 bg-gray-50 border border-gray-200 rounded-lg dark:bg-gray-800 dark:border-gray-700">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                    <span x-show="!$store.memoryDashboardStore.initializingMemory">Searching memories...</span>
                    <span x-show="$store.memoryDashboardStore.initializingMemory">Initializing memory database...</span>
                </div>

                <!-- Error state -->
                <div x-show="$store.memoryDashboardStore.error" class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400 border border-red-200 dark:border-red-800">
                    <span x-text="$store.memoryDashboardStore.error"></span>
                </div>

                <!-- Memory table -->
                <div x-show="!$store.memoryDashboardStore.loading && !$store.memoryDashboardStore.error"
                    class="flex flex-col flex-1 min-h-0 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">

                    <!-- Status Bar -->
                    <div class="flex flex-col sm:flex-row justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 gap-3" x-show="!$store.memoryDashboardStore.loading">
                        <div class="flex flex-wrap items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-base">database</span>
                                Total: <strong class="text-gray-900 dark:text-white" x-text="$store.memoryDashboardStore.totalDbCount"></strong>
                            </span>
                            <span class="hidden sm:inline text-gray-300 dark:text-gray-600">•</span>
                            <span class="flex items-center gap-1">
                                Filtered: <strong class="text-gray-900 dark:text-white" x-text="$store.memoryDashboardStore.totalCount"></strong>
                            </span>
                            <span class="hidden sm:inline text-gray-300 dark:text-gray-600">•</span>
                            <span class="flex items-center gap-1">
                                Know: <strong class="text-gray-900 dark:text-white" x-text="$store.memoryDashboardStore.knowledgeCount"></strong>
                            </span>
                            <span class="hidden sm:inline text-gray-300 dark:text-gray-600">•</span>
                            <span class="flex items-center gap-1">
                                Conv: <strong class="text-gray-900 dark:text-white" x-text="$store.memoryDashboardStore.conversationCount"></strong>
                            </span>
                        </div>

                        <!-- Pagination -->
                        <div class="flex items-center gap-2" x-show="$store.memoryDashboardStore.totalPages > 1">
                            <button class="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 disabled:opacity-30 disabled:cursor-not-allowed" 
                                @click="$store.memoryDashboardStore.prevPage()"
                                :disabled="$store.memoryDashboardStore.currentPage === 1" title="Previous Page">
                                <span class="material-symbols-outlined">chevron_left</span>
                            </button>
                            <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                                <span>Page</span>
                                <input type="number" class="w-12 h-7 p-1 text-center text-xs border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
                                    x-model.number="$store.memoryDashboardStore.currentPage"
                                    @change="$store.memoryDashboardStore.goToPage($store.memoryDashboardStore.currentPage)"
                                    @keyup.enter="$store.memoryDashboardStore.goToPage($store.memoryDashboardStore.currentPage)"
                                    :min="1" :max="$store.memoryDashboardStore.totalPages" />
                                <span>of <strong class="text-gray-900 dark:text-white" x-text="$store.memoryDashboardStore.totalPages"></strong></span>
                            </div>
                            <button class="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 disabled:opacity-30 disabled:cursor-not-allowed" 
                                @click="$store.memoryDashboardStore.nextPage()"
                                :disabled="$store.memoryDashboardStore.currentPage === $store.memoryDashboardStore.totalPages"
                                title="Next Page">
                                <span class="material-symbols-outlined">chevron_right</span>
                            </button>
                        </div>
                    </div>

                    <!-- Mass action toolbar -->
                    <div x-show="$store.memoryDashboardStore.selectedCount > 0" 
                         class="flex justify-between items-center p-3 bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-blue-800 transition-all duration-300">
                        <div class="font-medium text-blue-800 dark:text-blue-200 text-sm">
                            <span x-text="$store.memoryDashboardStore.selectedCount"></span> selected
                        </div>

                        <div class="flex gap-2">
                            <button class="flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-700" 
                                @click="$store.memoryDashboardStore.bulkCopyMemories()" title="Copy Selected Content">
                                <span class="material-symbols-outlined text-sm">content_copy</span> Copy
                            </button>

                            <button class="flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-700"
                                @click="$store.memoryDashboardStore.bulkExportMemories()" title="Export Selected Memories">
                                <span class="material-symbols-outlined text-sm">download</span> Export
                            </button>

                            <button class="flex items-center gap-1 px-2 py-1 text-xs font-medium text-red-700 bg-white border border-gray-300 rounded hover:bg-red-50 dark:bg-gray-800 dark:text-red-400 dark:border-gray-600 dark:hover:bg-gray-700"
                                @click="$store.memoryDashboardStore.bulkDeleteMemories()" title="Delete Selected Memories">
                                <span class="material-symbols-outlined text-sm">delete</span> Delete
                            </button>

                            <button class="flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-600 bg-transparent hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-200" 
                                @click="$store.memoryDashboardStore.clearSelection()" title="Clear Selection">
                                <span class="material-symbols-outlined text-sm">close</span>
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-auto bg-white dark:bg-gray-900">
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-800 dark:text-gray-400 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="p-4 w-10">
                                        <div class="flex items-center">
                                            <input type="checkbox" :checked="$store.memoryDashboardStore.allSelected"
                                                :indeterminate="$store.memoryDashboardStore.someSelected && !$store.memoryDashboardStore.allSelected"
                                                @change="$store.memoryDashboardStore.toggleSelectAll()"
                                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                        </div>
                                    </th>
                                    <th scope="col" class="px-6 py-3 w-48">Metadata</th>
                                    <th scope="col" class="px-6 py-3">Preview</th>
                                    <th scope="col" class="px-6 py-3 w-20 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="memory in $store.memoryDashboardStore.paginatedMemories" :key="memory.id">
                                    <tr class="bg-white border-b dark:bg-gray-900 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer"
                                        :class="{'bg-blue-50 dark:bg-blue-900/10': memory.selected}"
                                        @click="$store.memoryDashboardStore.showMemoryDetails(memory)">
                                        
                                        <!-- Selection checkbox -->
                                        <td class="w-4 p-4" @click.stop="memory.selected = !memory.selected">
                                            <div class="flex items-center">
                                                <input type="checkbox" x-model="memory.selected" 
                                                    class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                            </div>
                                        </td>

                                        <!-- Metadata -->
                                        <td class="px-6 py-4 align-top">
                                            <div class="flex flex-col gap-2">
                                                <div>
                                                    <span class="px-2 py-1 text-xs font-bold text-white rounded-md uppercase"
                                                        :style="`background-color: ${$store.memoryDashboardStore.getAreaColor(memory.area)}`"
                                                        x-text="(memory.area || 'UNKNOWN').toUpperCase()"></span>
                                                </div>
                                                <div>
                                                    <template x-if="memory.knowledge_source">
                                                        <span class="px-2 py-0.5 text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300 rounded border border-purple-200 dark:border-purple-800">Knowledge</span>
                                                    </template>
                                                    <template x-if="!memory.knowledge_source">
                                                        <span class="px-2 py-0.5 text-xs font-medium bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-300 rounded border border-teal-200 dark:border-teal-800">Conversation</span>
                                                    </template>
                                                </div>
                                                <div class="font-mono text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                    <span x-text="$store.memoryDashboardStore.formatTimestamp(memory.timestamp, true)"
                                                        :title="$store.memoryDashboardStore.formatTimestamp(memory.timestamp, false)"></span>
                                                </div>
                                            </div>
                                        </td>

                                        <!-- Content preview -->
                                        <td class="px-6 py-4 align-top">
                                            <div class="text-sm text-gray-900 dark:text-white line-clamp-3 mb-2 font-mono leading-relaxed"
                                                x-text="memory.content_full">
                                            </div>
                                            <div class="flex flex-wrap gap-1" x-show="memory.tags && memory.tags.length > 0">
                                                <template x-for="tag in memory.tags" :key="tag">
                                                    <span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-800 border border-gray-200 rounded dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" x-text="tag"></span>
                                                </template>
                                            </div>
                                        </td>

                                        <!-- Actions -->
                                        <td class="px-6 py-4 text-right align-top" @click.stop>
                                            <div class="flex justify-end gap-1">
                                                <button class="p-1 text-gray-500 hover:text-blue-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-blue-400 dark:hover:bg-gray-700 rounded transition-colors"
                                                    @click="$store.memoryDashboardStore.copyToClipboard($store.memoryDashboardStore.formatMemoryForCopy(memory))"
                                                    title="Copy Memory">
                                                    <span class="material-symbols-outlined text-lg">content_copy</span>
                                                </button>

                                                <button class="p-1 text-gray-500 hover:text-red-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-red-400 dark:hover:bg-gray-700 rounded transition-colors"
                                                    @click="$store.memoryDashboardStore.deleteMemory(memory)"
                                                    title="Delete Memory">
                                                    <span class="material-symbols-outlined text-lg">delete</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- No memories message -->
                    <div x-show="$store.memoryDashboardStore.memories.length === 0 && !$store.memoryDashboardStore.message"
                        class="flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400 italic">
                        <span class="material-symbols-outlined text-4xl mb-2 opacity-50">inbox</span>
                        <p>No memories found matching the current filters.</p>
                    </div>

                    <!-- Initialization message -->
                    <div x-show="$store.memoryDashboardStore.message" class="p-4 text-center text-blue-600 bg-blue-50 dark:text-blue-400 dark:bg-blue-900/20 border-t border-blue-100 dark:border-blue-800">
                        <span x-text="$store.memoryDashboardStore.message"></span>
                    </div>

                </div>

            </div>
        </template>
    </div>
</body>
</html>