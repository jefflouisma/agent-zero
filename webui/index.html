<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Agent Zero</title>
    <link rel="icon" type="image/svg+xml" href="public/favicon.svg">
    <link rel="stylesheet" href="dist/output.css">

    <!-- Flatpickr for datetime picker -->
    <link rel="stylesheet" href="vendor/flatpickr/flatpickr.min.css">
    <script src="vendor/flatpickr/flatpickr.min.js"></script>

    <!-- Google Fonts: Plus Jakarta Sans & Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        globalThis.safeCall = function (name, ...args) {
            if (window[name]) window[name](...args)
        }
    </script>

    <!-- Pre-initialize schedulerSettings to ensure Alpine doesn't miss it -->
    <script>
        // Pre-define schedulerSettings skeleton to ensure it's available to Alpine
        globalThis.schedulerSettings = function () {
            return {
                tasks: [],
                isLoading: true,
                selectedTask: null,
                expandedTaskId: null,
                sortField: 'name',
                sortDirection: 'asc',
                filterType: 'all',
                filterState: 'all',
                pollingInterval: null,
                pollingActive: false,
                editingTask: {
                    name: '',
                    type: 'scheduled',
                    state: 'idle',
                    schedule: {
                        minute: '*',
                        hour: '*',
                        day: '*',
                        month: '*',
                        weekday: '*',
                        timezone: ''
                    },
                    token: '',
                    plan: {
                        todo: [],
                        in_progress: null,
                        done: []
                    },
                    system_prompt: '',
                    prompt: '',
                    attachments: []
                },
                isCreating: false,
                isEditing: false,
                showLoadingState: false,
                viewMode: 'list',
                selectedTaskForDetail: null,
                attachmentsText: '',
                filteredTasks: [],
                // Minimal init to avoid errors
                init() {
                    console.log('Basic schedulerSettings initialized');
                    // Watch for task type changes
                    this.$watch('editingTask.type', (newType) => {
                        if (newType === 'planned') {
                            // When switching to planned task type, initialize the datetime picker
                            this.$nextTick(() => {
                                if (this.initFlatpickr) {
                                    if (this.isCreating) {
                                        this.initFlatpickr('create');
                                    } else if (this.isEditing) {
                                        this.initFlatpickr('edit');
                                    }
                                }
                            });
                        }
                    });
                }
            };
        };
    </script>

    <!-- Load module scripts first -->
    <script type="module" src="js/scheduler.js"></script>

    <script type="module" src="index.js"></script>

    <!-- Bootstrap JS (only for logic, importing bundled CSS => UI conflicts) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!-- Then load Alpine.js -->
    <!-- <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script> -->
    <script type="module" src="js/initFw.js"></script>

    <script src="vendor/ace-min/ace.js"></script>
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="vendor/katex/katex.min.css" crossorigin="anonymous">

    <!-- KaTeX javascript -->
    <script defer src="vendor/katex/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="vendor/katex/katex.auto-render.min.js" crossorigin="anonymous"></script>

    <!-- QR Code Library -->
    <script src="vendor/qrcode.min.js"></script>

    <!-- Google Icons -->
    <link rel="stylesheet" href="vendor/google/google-icons.css" />

    <!-- Link the PWA manifest file -->
    <link rel="manifest" href="js/manifest.json">

    <!-- Non-module scripts after Alpine.js -->
    <script type="text/javascript" src="js/settings.js"></script>
    <script>
        // Expose git info for sidebar component
        globalThis.gitinfo = { version: "{{version_no}}", commit_time: "{{version_time}}" };
    </script>
    <script src="vendor/flowbite/flowbite.min.js"></script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 h-screen overflow-hidden" x-data>
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" x-data>
            <template x-if="$store.sidebar">
                <div class="fixed inset-0 z-30 bg-gray-900/50 dark:bg-gray-900/80 transition-opacity opacity-0 pointer-events-none" 
                     :class="{'opacity-100 pointer-events-auto': $store.sidebar.isOpen && $store.sidebar.isMobile()}" 
                     @click="$store.sidebar.close()"></div>
            </template>
        </div>
        </template>
        <!-- Left Sidebar (Header Icons, Quick Actions, Tabs, Chats, Tasks) -->
        <x-component path="sidebar/left-sidebar.html"></x-component>

        <!-- Right Panel (Message History and Input Section) -->
        <div id="right-panel" class="relative flex flex-col flex-1 overflow-hidden bg-gray-50 dark:bg-gray-900" >

            <!-- top section with time, status etc. -->
            <x-component path="chat/top-section/chat-top.html"></x-component>

            <!-- Welcome Screen Component -->
            <div x-data x-show="$store.welcomeStore && $store.welcomeStore.isVisible">
                <x-component path="welcome/welcome-screen.html"></x-component>
            </div>
            <!-- Message History (actual messages) -->
            <div id="chat-history" class="flex flex-col flex-grow w-full overflow-y-auto overflow-x-hidden p-4 scroll-smooth scrollbar-thin scrollbar-thumb-gray-500 scrollbar-track-transparent" x-data x-show="!$store.welcomeStore || !$store.welcomeStore.isVisible"></div>

            <!-- NEW: Toast Stack Component -->
            <div style="position: relative; height: 0;">
                <x-component path="notifications/notification-toast-stack.html"></x-component>
            </div>

            <!-- Chat Input Area -->
            <div x-show="!$store.welcomeStore || !$store.welcomeStore.isVisible">
                <!-- Progress Bar -->
                <x-component path="chat/input/progress.html"></x-component>
                <!-- Input Section -->
                <x-component path="chat/input/chat-bar.html"></x-component>
            </div>
        </div>
    </div>
    <div id="settingsModal" x-data="settingsModalProxy">
        <template x-teleport="body">
            <!-- Modal Overlay -->
            <div x-show="isOpen" 
                 class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/50 dark:bg-gray-900/80 backdrop-blur-sm"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @click.self="handleCancel()"
                 @keydown.escape.window="isOpen && handleCancel()">
                
                <!-- Modal Container -->
                <div class="relative w-full max-w-4xl max-h-[90vh] bg-white rounded-lg shadow-xl dark:bg-gray-800 flex flex-col"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
                    
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 shrink-0">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white" x-text="settings.title"></h3>
                        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" @click="handleCancel()">
                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                            </svg>
                            <span class="sr-only">Close modal</span>
                        </button>
                    </div>

                    <!-- Modal Content -->
                    <div class="flex flex-col flex-1 min-h-0 overflow-hidden">
                        <!-- Tab Navigation -->
                        <div class="border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 px-4 shrink-0">
                            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center text-gray-500 dark:text-gray-400">
                                <li class="mr-2">
                                    <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" 
                                            :class="activeTab === 'agent' ? 'text-blue-600 border-blue-600 dark:text-blue-500 dark:border-blue-500' : 'border-transparent'"
                                            @click="switchTab('agent')" data-tab="agent">Agent Settings</button>
                                </li>
                                <li class="mr-2">
                                    <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300"
                                            :class="activeTab === 'external' ? 'text-blue-600 border-blue-600 dark:text-blue-500 dark:border-blue-500' : 'border-transparent'"
                                            @click="switchTab('external')" data-tab="external">External Services</button>
                                </li>
                                <li class="mr-2">
                                    <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300"
                                            :class="activeTab === 'mcp' ? 'text-blue-600 border-blue-600 dark:text-blue-500 dark:border-blue-500' : 'border-transparent'"
                                            @click="switchTab('mcp')" data-tab="mcp">MCP/A2A</button>
                                </li>
                                <li class="mr-2">
                                    <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300"
                                            :class="activeTab === 'developer' ? 'text-blue-600 border-blue-600 dark:text-blue-500 dark:border-blue-500' : 'border-transparent'"
                                            @click="switchTab('developer')" data-tab="developer">Developer</button>
                                </li>
                                <li class="mr-2">
                                    <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300"
                                            :class="activeTab === 'scheduler' ? 'text-blue-600 border-blue-600 dark:text-blue-500 dark:border-blue-500' : 'border-transparent'"
                                            @click="switchTab('scheduler')" data-tab="scheduler">Task Scheduler</button>
                                </li>
                                <li class="mr-2">
                                    <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300"
                                            :class="activeTab === 'backup' ? 'text-blue-600 border-blue-600 dark:text-blue-500 dark:border-blue-500' : 'border-transparent'"
                                            @click="switchTab('backup')" data-tab="backup">Backup & Restore</button>
                                </li>
                            </ul>
                        </div>

                        <!-- Display settings sections for agent, external, developer, mcp, backup tabs -->
                        <div class="overflow-y-auto p-3 space-y-3 flex-1" x-show="activeTab !== 'scheduler'">
                            <!-- Side Navigation for Sections within Tab (optional, can be simplified to just vertical scroll) -->
                            <!-- For now, simplifying to just stacked sections as per modern UI trends -->
                            
                            <template x-for="(section, sectionIndex) in filteredSections" :key="sectionIndex">
                                <div :id="'section' + (sectionIndex + 1)" class="p-3 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700 mb-2">
                                    <div class="flex items-center gap-1.5 mb-1">
                                        <img :src="'/public/' + section.id +'.svg'" :alt="section.title" class="w-5 h-5" onerror="this.style.display='none'">
                                        <h4 class="text-base font-bold text-gray-900 dark:text-white" x-text="section.title"></h4>
                                    </div>
                                    <div class="mb-1 text-xs text-gray-500 dark:text-gray-400" x-html="section.description"></div>

                                    <div class="space-y-1.5">
                                        <template x-for="(field, fieldIndex) in section.fields.filter(f => !f.hidden)" :key="fieldIndex">
                                            <div>
                                                <div x-show="field.title || field.description">
                                                    <label class="block text-sm font-medium text-gray-900 dark:text-white" x-text="field.title" x-show="field.title"></label>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400" x-html="field.description || ''" x-show="field.description"></p>
                                                </div>

                                                <div>
                                                    <!-- Input field -->
                                                    <template x-if="field.type === 'text'">
                                                        <input type="text" 
                                                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                                            :value="field.value"
                                                            :readonly="field.readonly === true"
                                                            @input="field.value = $event.target.value">
                                                    </template>

                                                    <!-- Number field -->
                                                    <template x-if="field.type === 'number'">
                                                        <input type="number" 
                                                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                                            :value="field.value"
                                                            :readonly="field.readonly === true"
                                                            @input="field.value = $event.target.value" 
                                                            :min="field.min" :max="field.max" :step="field.step">
                                                    </template>

                                                    <!-- Password field -->
                                                    <template x-if="field.type === 'password'">
                                                        <input type="password" 
                                                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                                            :value="field.value"
                                                            :readonly="field.readonly === true" 
                                                            :id="field.id"
                                                            autocomplete="off" 
                                                            @input="field.value = $event.target.value">
                                                    </template>

                                                    <!-- Textarea field -->
                                                    <template x-if="field.type === 'textarea'">
                                                        <textarea 
                                                            class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                                            :value="field.value"
                                                            :readonly="field.readonly === true"
                                                            @input="field.value = $event.target.value"
                                                            rows="4"></textarea>
                                                    </template>

                                                    <!-- Switch field -->
                                                    <template x-if="field.type === 'switch'">
                                                        <label class="relative inline-flex items-center cursor-pointer">
                                                            <input type="checkbox" 
                                                                class="sr-only peer" 
                                                                :checked="field.value"
                                                                :disabled="field.readonly === true"
                                                                @change="field.value = $event.target.checked">
                                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                                        </label>
                                                    </template>

                                                    <!-- Range field -->
                                                    <template x-if="field.type === 'range'">
                                                        <div class="flex items-center gap-4">
                                                            <input type="range" 
                                                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                                                :min="field.min" :max="field.max" :step="field.step" 
                                                                :value="field.value"
                                                                :disabled="field.readonly === true"
                                                                @input="field.value = $event.target.value">
                                                            <span class="text-sm font-medium text-gray-900 dark:text-white min-w-[3ch]" x-text="field.value"></span>
                                                        </div>
                                                    </template>

                                                    <!-- Button field -->
                                                    <template x-if="field.type === 'button'">
                                                        <button type="button" 
                                                            class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800"
                                                            :disabled="field.readonly === true"
                                                            @click="handleFieldButton(field)" 
                                                            x-text="field.value"></button>
                                                    </template>

                                                    <!-- Select field -->
                                                    <template x-if="field.type === 'select'">
                                                        <select 
                                                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                                                            x-model="field.value"
                                                            :disabled="field.readonly === true">
                                                            <template x-for="option in field.options" :key="option.value">
                                                                <option :value="option.value" x-text="option.label"
                                                                    :selected="option.value === field.value"></option>
                                                            </template>
                                                        </select>
                                                    </template>

                                                    <!-- HTML field -->
                                                    <template x-if="field.type === 'html'">
                                                        <div class="prose dark:prose-invert max-w-none text-sm" x-html="field.value"></div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Tunnel section content - only visible in External Services tab -->
                            <div id="section-tunnel" x-show="activeTab === 'external'" class="mb-6">
                                <x-component path="settings/tunnel/tunnel-section.html" />
                            </div>
                        </div>

                        <!-- Task Scheduler Tab Content -->
                        <div id="scheduler-tab-content" x-show="activeTab === 'scheduler'" x-cloak class="overflow-y-auto flex-1 p-6">
                            <!-- Settings section structure for task scheduler -->
                            <x-component path="settings/scheduler/scheduler-section.html"></x-component>                        
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="flex items-center justify-end p-4 border-t border-gray-200 dark:border-gray-700 space-x-2 shrink-0">
                        <template x-for="button in settings.buttons" :key="button.id">
                            <button type="button" 
                                :class="button.id === 'save' 
                                    ? 'text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800' 
                                    : 'text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600'"
                                @click="handleButton(button.id)"
                                x-text="button.title"></button>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Drag and Drop Overlay Component -->
    <x-component path="chat/attachments/dragDropOverlay.html"></x-component>

    <!-- Register Service Worker for offline support and caching -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('js/sw.js').then(registration => {
                    console.log('SW registered: ', registration);
                }).catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }
    </script>

</body>

</html>
